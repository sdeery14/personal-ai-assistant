# Implementation Plan: Agent Notifications

**Branch**: `010-agent-notifications` | **Date**: 2026-02-22 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/010-agent-notifications/spec.md`

## Summary

Give the agent the ability to send persistent notifications to users during conversations. Notifications are stored in PostgreSQL, surfaced via a bell icon + dropdown panel in the frontend, and optionally delivered by email. Users configure delivery preferences (in-app, email, both) and quiet hours. Rate limiting prevents notification spam. Email deferral handles quiet hours without requiring a full job queue.

## Technical Context

**Language/Version**: Python 3.12 (backend), TypeScript/Next.js 15 (frontend)
**Primary Dependencies**: FastAPI, OpenAI Agents SDK, asyncpg, aiosmtplib (new), React, Tailwind CSS
**Storage**: PostgreSQL (notifications, preferences, deferred emails), Redis (rate limiting)
**Testing**: pytest (backend unit), Vitest + React Testing Library (frontend), Playwright (E2E)
**Target Platform**: Docker (Linux containers), browser frontend
**Project Type**: Web application (backend API + frontend SPA)
**Performance Goals**: Notification list < 1s for 1,000 items, email delivery < 30s
**Constraints**: No WebSocket (deferred to Feature 011), no job queue, async email only
**Scale/Scope**: Low volume initially (tens of notifications/user/day), single-digit concurrent users

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Clarity over Cleverness | PASS | Each component has a single responsibility: tool creates, service persists, email service delivers, API serves, frontend displays |
| II. Evaluation-First | PASS | Unit tests for service, tool, and email delivery. Frontend component tests. Integration tests for API endpoints |
| III. Tool Safety | PASS | `send_notification` tool has schema validation (type enum, message length), rate limiting via Redis, clear error responses |
| IV. Privacy by Default | PASS | Notifications scoped by user_id, email addresses not logged, per-user data isolation enforced at query level |
| V. Consistent UX | PASS | Notification panel follows existing UI patterns (dropdown, consistent styling, dark mode support) |
| VI. Performance & Cost | PASS | No LLM calls for notifications. Email is async/non-blocking. Rate limiting prevents runaway costs. Redis-based rate checks are sub-millisecond |
| VII. Observability | PASS | Structured logging for notification creation, email delivery, rate limit hits, and failures. Correlation IDs carried through |
| VIII. Reproducible Environments | PASS | `aiosmtplib` added via `uv add`. All config via environment variables in Settings |

**Post-design re-check**: All gates still pass. No new violations introduced.

## Project Structure

### Documentation (this feature)

```text
specs/010-agent-notifications/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Technology decisions
├── data-model.md        # Database schema
├── quickstart.md        # Setup and verification
├── contracts/
│   ├── notifications-api.yaml    # OpenAPI spec
│   └── send-notification-tool.md # Agent tool contract
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
# Backend (Python/FastAPI)
src/
├── api/
│   └── notifications.py       # NEW: /notifications/* endpoints
├── models/
│   └── notification.py        # NEW: Pydantic models
├── services/
│   ├── notification_service.py # NEW: CRUD, rate limiting, preferences
│   └── email_service.py       # NEW: Async SMTP delivery
├── tools/
│   └── send_notification.py   # NEW: Agent tool
└── config.py                  # MODIFIED: Add email/notification settings

migrations/
└── 009_notifications.sql      # NEW: Tables + indexes

# Frontend (TypeScript/Next.js)
frontend/src/
├── components/
│   └── notification/          # NEW: NotificationBell, NotificationPanel, NotificationItem
├── hooks/
│   └── useNotifications.ts    # NEW: Data fetching hook
├── types/
│   └── notification.ts        # NEW: TypeScript interfaces
└── components/layout/
    └── Header.tsx             # MODIFIED: Add NotificationBell

# Tests
tests/unit/
├── test_notification_service.py  # NEW
├── test_notification_tool.py     # NEW
└── test_email_service.py         # NEW

frontend/
└── src/components/notification/__tests__/  # NEW: Component tests
```

**Structure Decision**: Follows the existing web application layout. Backend adds a new API route module, service, tool, and migration following established patterns. Frontend adds a new component directory and hook following the existing `memory/` and `knowledge/` patterns.

## Complexity Tracking

No constitution violations to justify. All components follow existing patterns.
