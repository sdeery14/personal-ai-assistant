# Implementation Plan: Dark Mode & Theming

**Branch**: `009-dark-mode` | **Date**: 2026-02-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/009-dark-mode/spec.md`

## Summary

Add dark mode support to the existing Next.js frontend with system-aware detection, a 3-way manual toggle (Light/Dark/System), persistent preference via localStorage, and consistent dark palette across all 20+ components and 8 pages. Uses `next-themes` for FOUC-free theme management and Tailwind CSS v4 `dark:` variants for styling.

## Technical Context

**Language/Version**: TypeScript 5.x (Next.js 16, React 19)
**Primary Dependencies**: next-themes (theme management + FOUC prevention), Tailwind CSS v4 (dark variant styling)
**Storage**: localStorage (browser-local theme preference, managed by next-themes)
**Testing**: Visual inspection across all pages in both themes; contrast ratio verification
**Target Platform**: Web browsers (desktop and mobile)
**Project Type**: Web application (frontend-only changes)
**Performance Goals**: Theme switch <100ms perceived; zero FOUC on page load
**Constraints**: WCAG 2.1 AA contrast ratios (4.5:1 normal text, 3:1 large text)
**Scale/Scope**: ~20 components, 8 pages, 5 UI primitives, 2 layouts to update

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Clarity over Cleverness | PASS | Single `next-themes` provider + Tailwind dark variants. No magic — explicit class-based toggling. |
| II. Evaluation-First Behavior | PASS | Visual verification checklist for all pages/components in both themes. Contrast ratio spot-checks. |
| III. Tool Safety and Correctness | N/A | No backend tools or API changes. |
| IV. Privacy by Default | PASS | Theme stored in localStorage only — no server-side storage, no PII. |
| V. Consistent UX | PASS | All pages themed consistently. Toggle accessible from every page via header. |
| VI. Performance and Cost Budgets | PASS | <100ms theme switch. next-themes script prevents FOUC with zero runtime cost. No API calls. |
| VII. Observability and Debuggability | N/A | Client-side visual feature — no logging needed. |
| VIII. Reproducible Environments | PASS | next-themes added via npm (package-lock.json committed). |

**Post-design re-check**: All gates still pass. No new dependencies beyond next-themes. No backend changes.

## Project Structure

### Documentation (this feature)

```text
specs/009-dark-mode/
├── plan.md              # This file
├── research.md          # Technology decisions
├── quickstart.md        # Testing scenarios
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (frontend only — no backend changes)

```text
frontend/
├── src/
│   ├── app/
│   │   ├── layout.tsx                    # Add ThemeProvider, suppressHydrationWarning
│   │   ├── globals.css                   # Add @custom-variant dark, CSS custom properties
│   │   ├── (auth)/
│   │   │   ├── layout.tsx                # Dark variants for auth background
│   │   │   ├── login/page.tsx            # Dark variants
│   │   │   └── setup/page.tsx            # Dark variants
│   │   └── (main)/
│   │       ├── layout.tsx                # Dark variants
│   │       ├── chat/page.tsx             # (no changes — delegates to components)
│   │       ├── memory/page.tsx           # (no changes — delegates to components)
│   │       ├── knowledge/page.tsx        # (no changes — delegates to components)
│   │       └── admin/page.tsx            # Dark variants for table, forms
│   ├── components/
│   │   ├── ui/
│   │   │   ├── Button.tsx                # Dark variants for all button states
│   │   │   ├── Input.tsx                 # Dark variants for input, label, error
│   │   │   ├── Card.tsx                  # Dark variants for background, border
│   │   │   ├── Dialog.tsx                # Dark variants for overlay, panel
│   │   │   └── Skeleton.tsx              # Dark variants for loading pulse
│   │   ├── chat/
│   │   │   ├── ChatInput.tsx             # Dark variants for textarea, send button
│   │   │   ├── ChatError.tsx             # Dark variants for error display
│   │   │   ├── MessageBubble.tsx         # Dark variants + syntax highlight theme switch
│   │   │   ├── MessageList.tsx           # Dark variants for empty state, scroll button
│   │   │   └── StreamingIndicator.tsx    # Dark variants for dots
│   │   ├── conversation/
│   │   │   ├── ConversationItem.tsx      # Dark variants for item, active state, hover
│   │   │   └── ConversationList.tsx      # Dark variants for list, new button
│   │   ├── memory/
│   │   │   ├── MemoryCard.tsx            # Dark variants for card, type badges
│   │   │   └── MemoryList.tsx            # Dark variants for search, filters
│   │   ├── knowledge/
│   │   │   ├── EntityDetail.tsx          # Dark variants for detail panel, relationships
│   │   │   └── EntityList.tsx            # Dark variants for search, filters
│   │   └── layout/
│   │       ├── Header.tsx                # Dark variants + ThemeToggle placement
│   │       ├── Sidebar.tsx               # Dark variants for nav, mobile drawer
│   │       ├── ErrorBoundary.tsx         # Dark variants for error fallback
│   │       └── ThemeToggle.tsx           # NEW: 3-way toggle (Light/Dark/System)
│   └── lib/
│       └── (no changes)
└── package.json                          # Add next-themes dependency
```

**Structure Decision**: Frontend-only changes. No new directories — ThemeToggle is the only new file. All other changes are adding `dark:` Tailwind variants to existing components.

## Key Technical Decisions

### 1. next-themes for Theme Management

- Provides ThemeProvider, useTheme hook, and automatic FOUC prevention
- Injects a blocking `<script>` that reads localStorage and applies theme class before React hydrates
- Handles localStorage persistence, system preference detection, and cross-tab sync automatically
- Configured with `attribute="class"` to toggle `.dark` class on `<html>`

### 2. Tailwind CSS v4 Dark Variant

- Add `@custom-variant dark (&:where(.dark, .dark *));` to globals.css
- This enables `dark:` utility classes throughout all components
- Works with next-themes `.dark` class on `<html>`

### 3. Syntax Highlighting Theme Pair

- Light: `oneLight` (familiar VS Code-like appearance)
- Dark: `vscDarkPlus` (VS Code dark theme, widely recognized)
- MessageBubble uses `useTheme()` + `resolvedTheme` to select the correct style

### 4. FOUC Prevention

- next-themes handles this automatically via injected head script
- `suppressHydrationWarning` added to `<html>` element in root layout
- ThemeToggle uses `mounted` state pattern to avoid hydration mismatch

### 5. Theme Toggle UX

- 3-way cycle button in the Header: Light → Dark → System → Light
- Shows icon for current resolved theme (sun/moon) with indicator for system mode
- Uses `useTheme()` hook from next-themes

## Dark Color Palette

| Element | Light | Dark |
|---------|-------|------|
| Page background | white / gray-50 | gray-900 / gray-950 |
| Card/panel background | white | gray-800 |
| Primary text | gray-900 | gray-100 |
| Secondary text | gray-500 / gray-600 | gray-400 |
| Border | gray-200 | gray-700 |
| Input background | white | gray-800 |
| Input border | gray-300 | gray-600 |
| Sidebar background | gray-50 | gray-900 |
| Active item | blue-50 | blue-900/30 |
| Primary button | blue-600 | blue-500 |
| Danger button | red-600 | red-500 |
| Error text | red-600 | red-400 |
| Success text | green-600 | green-400 |
| Type badges | (color)-100/(color)-800 | (color)-900/(color)-200 |
